version: '2.4'

services:
  gateway-service:
    build: ./gateway-service
    restart: unless-stopped
    network_mode: host
    ports:
      - "4467:4467"
      - "1680:1680"
    volumes:
      - gateway-data:/etc/helium_gateway
      - gateway-logs:/var/log
    devices:
      - "/dev/gpiomem:/dev/gpiomem"
      - "/dev/spidev0.0:/dev/spidev0.0:rwm"
    cap_add: [SYS_RAWIO]
    environment:
      - GW_REGION=EU868
    command: >
      sh -c "
        # Създай I2C device ако не съществува
        if [ ! -e /dev/i2c-1 ]; then
          mknod /dev/i2c-1 c 89 1 2>/dev/null || true
          chmod 666 /dev/i2c-1
        fi
        # Стартирай gateway скрипта
        exec /opt/gateway/start-gateway.sh
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4467/"]
      interval: 10s
      timeout: 10s
      retries: 18
      start_period: 40s
    labels:
      io.balena.features.balena-api: '1'
      io.balena.features.supervisor-api: '1'

  gwmp-mux:
    build: ./gwmp-mux
    restart: unless-stopped
    network_mode: host
    environment:
      RUST_LOG: info
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "1700"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    depends_on:
      gateway-service:
        condition: service_healthy

  packet-forwarder:
    image: rakwireless/udp-packet-forwarder:latest
    restart: unless-stopped
    privileged: true
    network_mode: host
    devices:
      - "/dev/spidev0.0:/dev/spidev0.0:rwm"
      - "/dev/gpiomem:/dev/gpiomem"
    environment:
      MODEL: "RAK2287"
      CONCENTRATOR: "SX1302"
      INTERFACE: "SPI"
      HAS_GPS: 0
      HAS_LTE: 0
      RESET_GPIO: 17
      POWER_EN_GPIO: 18
      RADIO_DEV: "/dev/spidev0.0"
      SPI_SPEED: 8000000
      STARTUP_DELAY: 300
      BAND: "eu_863_870"
      SERVER_HOST: "127.0.0.1"
      SERVER_PORT: 1700
      GPS_LATITUDE: "41.2256"
      GPS_LONGITUDE: "25.535"
      GPS_ALTITUDE: "200"
    depends_on:
      gateway-service:
        condition: service_healthy
      gwmp-mux:
        condition: service_healthy

volumes:
  gateway-data:
  gateway-logs: