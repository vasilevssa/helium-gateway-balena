# Docker Compose for Helium Gateway with RAK2287
version: '2.4'

services:
  gateway-service:
    build: ./gateway-service
    restart: unless-stopped
    ports:
      - "4467:4467"      # gateway-rs API
    volumes:
      - gateway-data:/etc/helium_gateway
      - gateway-logs:/var/log
    privileged: true
    devices:
      - "/dev/gpiochip0"
      - "/dev/gpiochip1"
    cap_add: [SYS_RAWIO]
    environment:
      - REGION_OVERRIDE=${REGION_OVERRIDE:-US915}
    labels:
      io.balena.features.balena-api: '1'
      io.balena.features.supervisor-api: '1'

  gwmp-mux:
    build: ./gwmp-mux
    restart: unless-stopped
    ports:
      - "1700:1700/udp"
    environment:
      RUST_LOG: debug
    depends_on:
      gateway-service:
        condition: service_started
    # volumes:
    #   - packet-logs:/var/log/packets

  packet-forwarder:
    image: rakwireless/udp-packet-forwarder:latest
    restart: unless-stopped
    privileged: true
    environment:
      MODEL: "SX1302"
      CONCENTRATOR: "SX1302"
      INTERFACE: "SPI"
      HAS_GPS: 0
      HAS_LTE: 0
      RESET_GPIO: 15
      POWER_EN_GPIO: 23
      RADIO_DEV: "/dev/spidev0.0"
      SPI_SPEED: 8000000
      STARTUP_DELAY: 15
      BAND: "us_902_928"
      SERVER_HOST: "gwmp-mux"
      SERVER_PORT: 1700
      GPS_LATITUDE: 38.851137
      GPS_LONGITUDE: -121.269953
      GPS_ALTITUDE: 0
    depends_on:
      gwmp-mux:
        condition: service_started

  # packet-logger:
  #   build: ./packet-logger
  #   restart: unless-stopped
  #   environment:
  #     RUST_LOG: info
  #     DEVICE_FILTER: "${DEVICE_FILTER:-}"
  #     LOG_ALL_PACKETS: "${LOG_ALL_PACKETS:-true}"
  #   volumes:
  #     - packet-logs:/var/log/packets
  #     - device-logs:/var/log/devices

volumes:
    gateway-data:
    gateway-logs:
    # packet-logs:
    # device-logs:
    # raw-logs:
  