version: '2.4'

services:
  gateway-service:
    build: ./gateway-service
    restart: unless-stopped
    ports:
      - "4467:4467"      # gateway-rs API
      - "1680:1680"      # packet forwarder port
    volumes:
      - gateway-data:/etc/helium_gateway
      - gateway-logs:/var/log
    devices:
      - "/dev/i2c-1:/dev/i2c-1"
      - "/dev/gpiomem:/dev/gpiomem"
    cap_add: [SYS_RAWIO]
    environment:
      - GW_REGION=EU868
      - ECC_CHIP=True
    networks:
      - balena-network
    labels:
      io.balena.features.balena-api: '1'
      io.balena.features.supervisor-api: '1'

  gwmp-mux:
    build: ./gwmp-mux
    restart: unless-stopped
    ports:
      - "1700:1700/udp"
    environment:
      RUST_LOG: info
    networks:
      - balena-network
    depends_on:
      - gateway-service

  packet-forwarder:
    image: rakwireless/udp-packet-forwarder:latest
    restart: unless-stopped
    privileged: true
    devices:
      - "/dev/spidev0.0:/dev/spidev0.0:rwm"
      - "/dev/gpiomem:/dev/gpiomem"
    environment:
      MODEL: "RAK2287"
      CONCENTRATOR: "SX1302"
      INTERFACE: "SPI"
      HAS_GPS: 0
      HAS_LTE: 0
      RESET_GPIO: 17
      POWER_EN_GPIO: 18
      RADIO_DEV: "/dev/spidev0.0"
      SPI_SPEED: 8000000
      STARTUP_DELAY: 15
      BAND: "eu_863_870"
      SERVER_HOST: "gwmp-mux"
      SERVER_PORT: 1700
      GPS_LATITUDE: "41.2256"    # üëà –¢–í–û–ò–¢–ï –ö–û–û–†–î–ò–ù–ê–¢–ò
      GPS_LONGITUDE: "25.535"    # üëà –¢–í–û–ò–¢–ï –ö–û–û–†–î–ò–ù–ê–¢–ò
      GPS_ALTITUDE: "200"        # üëà –ü–†–û–ú–ï–ù–ò —Å–ø–æ—Ä–µ–¥ –Ω–∞–¥–º–æ—Ä—Å–∫–∞—Ç–∞ –≤–∏—Å–æ—á–∏–Ω–∞
    networks:
      - balena-network
    depends_on:
      - gwmp-mux

volumes:
  gateway-data:
  gateway-logs:

networks:
  balena-network:
    driver: bridge